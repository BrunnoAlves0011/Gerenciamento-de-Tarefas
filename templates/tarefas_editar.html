<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Tarefa - Gerenciador de Tarefas</title>
    <link rel="stylesheet" href="/static/css/taf_criar.css">
    <script src="/static/js/toast.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-left">
                <button class="back-btn" onclick="goBack()">
                    ‚Üê Voltar
                </button>
                <h1>üñäÔ∏è Editar Tarefa</h1>
            </div>
        </header>

        <div class="form-container">
            <div class="form-header">
                <h2>Editar Tarefa</h2>
                <!-- <p>Preencha os dados abaixo para adicionar uma nova tarefa</p> -->
            </div>

            <div class="info-box">
                <div class="info-icon">üí°</div>
                <div>
                    <strong>Dica:</strong> Depois de editar a tarefa, n√£o esqueca de salvar, al√©m de que ap√≥s o
                    salvamento da edi√ß√£o, n√£o tem como voltar √° forma anterior, edite com cuidado!
                </div>
            </div>

            <form id="taskForm">
                <div class="form-group">
                    <label for="titulo">
                        T√≠tulo da Tarefa <span class="required">*</span>
                    </label>
                    <input type="text" value="{{ tarefa.titulo }}" id="titulo" name="titulo"
                        placeholder="Ex: Revisar proposta de projeto" maxlength="100" required
                        oninput="updateCharCounter('titulo', 100)">
                    <div class="char-counter">
                        <span id="titulo-counter">0</span>/100 caracteres
                    </div>
                </div>

                <div class="form-group">
                    <label for="descricao">
                        Descri√ß√£o <span class="required">*</span>
                    </label>
                    <textarea id="descricao" name="descricao" placeholder="Descreva os detalhes da tarefa..."
                        maxlength="300" required
                        oninput="updateCharCounter('descricao', 300)">{{ tarefa.descricao }}</textarea>
                    <div class="char-counter">
                        <span id="descricao-counter">0</span>/300 caracteres
                    </div>
                </div>

                <div class="form-group">
                    <label for="data">
                        Data de Vencimento
                    </label>
                    <input type="date" id="data" name="data" min="" value="{{ tarefa.data }}">
                </div>

                <div class="form-group">
                    <label>
                        Prioridade <span class="required">*</span>
                    </label>
                    <div class="radio-group">
                        <div class="radio-option">
                            {% if tarefa.prioridade.value == 'Urgente' %}
                            <input type="radio" id="urgente" name="prioridade" value="Urgente" required checked>
                            {% else %}
                            <input type="radio" id="urgente" name="prioridade" value="Urgente" required>
                            {% endif %}
                            <label for="urgente" class="radio-label priority-urgente">
                                üî¥ Urgente
                            </label>
                        </div>
                        <div class="radio-option">
                            {% if tarefa.prioridade.value == 'Alta' %}
                            <input type="radio" id="alta" name="prioridade" value="Alta" checked>
                            {% else %}
                            <input type="radio" id="alta" name="prioridade" value="Alta">
                            {% endif %}
                            <label for="alta" class="radio-label priority-alta">
                                üü† Alta
                            </label>
                        </div>
                        <div class="radio-option">
                            {% if tarefa.prioridade.value == 'Media' %}
                            <input type="radio" id="media" name="prioridade" value="Media" checked>
                            {% else %}
                            <input type="radio" id="media" name="prioridade" value="Media">
                            {% endif %}
                            <label for="media" class="radio-label priority-media">
                                üîµ M√©dia
                            </label>
                        </div>
                        <div class="radio-option">
                            {% if tarefa.prioridade.value == 'Baixa' %}
                            <input type="radio" id="baixa" name="prioridade" value="Baixa" checked>
                            {% else %}
                            <input type="radio" id="baixa" name="prioridade" value="Baixa">
                            {% endif %}
                            <label for="baixa" class="radio-label priority-baixa">
                                üü¢ Baixa
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        Categoria <span class="required">*</span>
                    </label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="trabalho" name="categoria" value="Trabalho" checked required>
                            <label for="trabalho" class="radio-label">
                                üíº Trabalho
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="pessoal" name="categoria" value="Pessoal">
                            <label for="pessoal" class="radio-label">
                                üë§ Pessoal
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="estudos" name="categoria" value="Estudos">
                            <label for="estudos" class="radio-label">
                                üìö Estudos
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="saude" name="categoria" value="Saude">
                            <label for="saude" class="radio-label">
                                ‚ù§Ô∏è Sa√∫de
                            </label>
                        </div>
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
                <div class="form-actions">
                    <!-- <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Limpar
                    </button> -->
                    <button type="submit" class="btn btn-primary" >
                        ‚úì Editar Tarefa
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.getElementById('data').min = new Date().toISOString().split('T')[0];

        function updateCharCounter(fieldId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(fieldId + '-counter');
            counter.textContent = field.value.length;

            if (field.value.length >= maxLength * 0.9) {
                counter.style.color = '#f44336';
            } else {
                counter.style.color = '#999';
            }
        }

        document.getElementById('taskForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const taskId = "{{ tarefa.id }}";
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            const response = await fetch(`/home/tarefa/edit/${taskId}`, {
                method: 'PATCH',
                body: data
            });

            if (response.ok) {
                showSuccess('Tarefa atualizada!');
                window.location.reload();
            } else {
                showError('Erro ao atualizar tarefa.');
            }
        });


        function goBack() {
            window.location.href = '/home';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = '‚úì ' + message;
            successDiv.style.display = 'block';

            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // document.getElementById('taskForm').addEventListener('submit', function (e) {
        //     const titulo = document.getElementById('titulo').value.trim();
        //     const descricao = document.getElementById('descricao').value.trim();

        //     if (titulo.length < 3) {
        //         e.preventDefault();
        //         showError('O t√≠tulo deve ter pelo menos 3 caracteres');
        //         return false;
        //     }

        //     if (descricao.length < 10) {
        //         e.preventDefault();
        //         showError('A descri√ß√£o deve ter pelo menos 10 caracteres');
        //         return false;
        //     }

        //     const submitBtn = document.getElementById('submitBtn');
        //     submitBtn.classList.add('btn-loading');
        //     submitBtn.textContent = '';
        // });

        document.getElementById('titulo').addEventListener('input', function () {
            if (this.value.length > 0 && this.value.length < 3) {
                this.style.borderColor = '#f44336';
            } else {
                this.style.borderColor = '#e0e0e0';
            }
        });

        document.getElementById('descricao').addEventListener('input', function () {
            if (this.value.length > 0 && this.value.length < 10) {
                this.style.borderColor = '#f44336';
            } else {
                this.style.borderColor = '#e0e0e0';
            }
        });

        let formChanged = false;
        document.getElementById('taskForm').addEventListener('input', function () {
            formChanged = true;
        });

        window.addEventListener('beforeunload', function (e) {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        document.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('taskForm').requestSubmit();
            }

            if (e.key === 'Escape') {
                resetForm();
            }
        });
    </script>
</body>

</html>