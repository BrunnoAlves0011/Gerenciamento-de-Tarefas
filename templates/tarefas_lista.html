<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todas as Tarefas - Gerenciador de Tarefas</title>
    <link rel="stylesheet" href="/static/css/taf_lista.css">
</head>

<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="back-btn" onclick="goBack()">
                        ← Voltar
                    </button>
                    <h1>📋 Todas as Tarefas</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="createTask()">
                        ➕ Nova Tarefa
                    </button>
                </div>
            </div>

            <div class="filters-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Buscar tarefas..." onkeyup="searchTasks()">
                    <span class="search-icon">🔍</span>
                </div>

                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterTasks('all')">Todas</button>
                    <button class="filter-btn" onclick="filterTasks('pending')">Pendentes</button>
                    <button class="filter-btn" onclick="filterTasks('completed')">Concluídas</button>
                </div>

                <select id="priorityFilter" onchange="applyFilters()">
                    <option value="">Prioridade</option>
                    <option value="high">Alta</option>
                    <option value="medium">Média</option>
                    <option value="low">Baixa</option>
                </select>

                <select id="categoryFilter" onchange="applyFilters()">
                    <option value="">Categoria</option>
                    <option value="trabalho">Trabalho</option>
                    <option value="pessoal">Pessoal</option>
                    <option value="estudos">Estudos</option>
                    <option value="saude">Saúde</option>
                </select>
            </div>
        </header>

        <div class="content-area">
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-number">{{ tarefas|length }}</div>
                    <div class="stat-label">Total de Tarefas</div>
                </div>
                <div class="stat-box completed">
                    <div class="stat-number">{{ tarefas | selectattr('concluido', 'equalto', True) | list | length }}
                    </div>
                    <div class="stat-label">Concluídas</div>
                </div>
                <div class="stat-box pending">
                    <div class="stat-number">{{ tarefas | selectattr('concluido', 'equalto', False)| list | length }}
                    </div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-box urgent">
                    <div class="stat-number">{{ tarefas | selectattr('prioridade', 'equalto', 'Urgente')| list | length
                        }}</div>
                    <div class="stat-label">Urgentes</div>
                </div>
            </div>

            <div class="tasks-container" id="tasksContainer">
                <!-- Inicio tarefas -->
                {% for tarefa in tarefas %}
                {% if tarefa.concluido == False %}
                <!-- Tarefas Urgentes -->
                {% if tarefa.prioridade == 'Urgente' %}
                <div class="task-card urgent" data-task-id="{{ tarefa.id }}" data-status="pending"
                    data-priority="urgent" data-category="trabalho">
                    <div class="task-header">
                        <div class="task-main">
                            <div class="task-title">{{ tarefa.titulo }}</div>
                            <div class="task-description">{{ tarefa.descricao }}</div>
                            <div class="task-meta">
                                <div class="meta-item">📅 {{ tarefa.data }}</div>
                                <div class="meta-item">
                                    <span class="priority-badge priority-urgent">{{ tarefa.prioridade }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="category-badge">
                                        {% if tarefa.categoria == 'Trabalho' %}
                                        💼
                                        {% elif tarefa.categoria == 'Pessoal' %}
                                        🙍‍♂️
                                        {% elif tarefa.categoria == 'Estudos' %}
                                        📚
                                        {% else %}
                                        📍
                                        {% endif %}
                                        {{ tarefa.categoria.value }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="action-btn complete" onclick="completeTask(this)" title="Concluir">✓</button>
                            <button class="action-btn edit" onclick="editTask(this)" title="Editar">✏️</button>
                            <button class="action-btn delete" onclick="deleteTask(this)" title="Excluir">🗑️</button>
                        </div>
                    </div>
                </div>

                {% elif tarefa.prioridade == 'Alta' %}
                <div class="task-card" data-task-id="{{ tarefa.id }}" data-status="pending" data-priority="high"
                    data-category="trabalho">
                    <div class="task-header">
                        <div class="task-main">
                            <div class="task-title">{{ tarefa.titulo }}</div>
                            <div class="task-description">{{ tarefa.descricao }}</div>
                            <div class="task-meta">
                                <div class="meta-item">📅 {{ tarefa.data }}</div>
                                <div class="meta-item">
                                    <span class="priority-badge priority-high">{{ tarefa.prioridade.value }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="category-badge">
                                        {% if tarefa.categoria == 'Trabalho' %}
                                        💼
                                        {% elif tarefa.categoria == 'Pessoal' %}
                                        🙍‍♂️
                                        {% elif tarefa.categoria == 'Estudos' %}
                                        📚
                                        {% else %}
                                        📍
                                        {% endif %}
                                        {{ tarefa.categoria.value }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="action-btn complete" onclick="completeTask(this)" title="Concluir">✓</button>
                            <button class="action-btn edit" onclick="editTask(this)" title="Editar">✏️</button>
                            <button class="action-btn delete" onclick="deleteTask(this)" title="Excluir">🗑️</button>
                        </div>
                    </div>
                </div>

                {% elif tarefa.prioridade == 'Media' %}
                <div class="task-card" data-task-id="{{ tarefa.id }}" data-status="pending" data-priority="medium"
                    data-category="estudos">
                    <div class="task-header">
                        <div class="task-main">
                            <div class="task-title">{{ tarefa.titulo }}</div>
                            <div class="task-description">{{ tarefa.descricao }}</div>
                            <div class="task-meta">
                                <div class="meta-item">📅 {{ tarefa.data }}</div>
                                <div class="meta-item">
                                    <span class="priority-badge priority-medium">{{ tarefa.prioridade.value }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="category-badge">
                                        {% if tarefa.categoria == 'Trabalho' %}
                                        💼
                                        {% elif tarefa.categoria == 'Pessoal' %}
                                        🙍‍♂️
                                        {% elif tarefa.categoria == 'Estudos' %}
                                        📚
                                        {% else %}
                                        📍
                                        {% endif %}
                                        {{ tarefa.categoria.value }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="action-btn complete" onclick="completeTask(this)" title="Concluir">✓</button>
                            <button class="action-btn edit" onclick="editTask(this)" title="Editar">✏️</button>
                            <button class="action-btn delete" onclick="deleteTask(this)" title="Excluir">🗑️</button>
                        </div>
                    </div>
                </div>

                {% elif tarefa.prioridade == 'Baixa' %}
                <div class="task-card" data-task-id="{{ tarefa.id }}" data-status="pending" data-priority="low"
                    data-category="{{ tarefa.categoria }}">
                    <div class="task-header">
                        <div class="task-main">
                            <div class="task-title">{{ tarefa.titulo }}</div>
                            <div class="task-description">{{ tarefa.descricao }}</div>
                            <div class="task-meta">
                                <div class="meta-item">📅 Quinta - 20:00</div>
                                <div class="meta-item">
                                    <span class="priority-badge priority-low">{{ tarefa.prioridade.value }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="category-badge">
                                        {% if tarefa.categoria == 'Trabalho' %}
                                        💼
                                        {% elif tarefa.categoria == 'Pessoal' %}
                                        🙍‍♂️
                                        {% elif tarefa.categoria == 'Estudos' %}
                                        📚
                                        {% else %}
                                        📍
                                        {% endif %}
                                        {{ tarefa.categoria.value }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="action-btn complete" onclick="completeTask(this)" title="Concluir">✓</button>
                            <button class="action-btn edit" onclick="editTask(this)" title="Editar">✏️</button>
                            <button class="action-btn delete" onclick="deleteTask(this)" title="Excluir">🗑️</button>
                        </div>
                    </div>
                </div>

                {% endif %} <!-- case prioridade -->
                {% endif %} <!-- if concluido == false -->
                {% endfor %} <!-- for tarefas in tarefa -->
                {% for tarefa in tarefas if tarefa.concluido %}
                <div class="task-card completed" data-task-id="{{ tarefa.id }}" data-status="completed"
                    data-priority="{{ tarefa.prioridade.value.lower() }}"
                    data-category="{{ tarefa.categoria.value.lower() }}">
                    <div class="task-header">
                        <div class="task-main">
                            <div class="task-title">{{ tarefa.titulo }}</div>
                            <div class="task-description">{{ tarefa.descricao }}</div>
                            <div class="task-meta">
                                {% if tarefa.data %}
                                <div class="meta-item">📅 {{ tarefa.data }}</div>
                                {% endif %}
                                <div class="meta-item">
                                    <span class="priority-badge priority-{{ tarefa.prioridade.value.lower() }}">
                                        {{ tarefa.prioridade.value }}
                                    </span>
                                </div>
                                <div class="meta-item">
                                    <span class="category-badge">
                                        {% if tarefa.categoria.value == 'Trabalho' %}💼
                                        {% elif tarefa.categoria.value == 'Pessoal' %}👤
                                        {% elif tarefa.categoria.value == 'Estudos' %}📚
                                        {% elif tarefa.categoria.value == 'Saude' %}❤️
                                        {% endif %}
                                        {{ tarefa.categoria.value }}
                                    </span>
                                </div>
                                <div class="meta-item">✅ Concluída</div>
                            </div>
                        </div>
                        <div class="task-actions">
                            <!-- Não mostra botão de concluir em tarefas já concluídas -->
                            <button class="action-btn edit" onclick="editTask(this)" title="Editar">✏️</button>
                            <button class="action-btn delete" onclick="deleteTask(this)" title="Excluir">🗑️</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <!-- Fim tarefas -->
            </div>
        </div>
    </div>

    <script>
        let currentFilter = 'all';

        function goBack() {
            window.location.href = '/home';
        }

        function createTask() {
            alert('Abrindo formulário para criar nova tarefa...');
        }

        function filterTasks(filter) {
            currentFilter = filter;

            // Atualizar botões ativos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const priority = document.getElementById('priorityFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const tasks = document.querySelectorAll('.task-card');

            tasks.forEach(task => {
                const status = task.dataset.status;
                const taskPriority = task.dataset.priority;
                const taskCategory = task.dataset.category;
                const title = task.querySelector('.task-title').textContent.toLowerCase();
                const description = task.querySelector('.task-description').textContent.toLowerCase();

                let show = true;

                // Filtro de status
                if (currentFilter !== 'all') {
                    if (currentFilter === 'completed' && status !== 'completed') show = false;
                    if (currentFilter === 'pending' && status !== 'pending') show = false;
                }

                // Filtro de prioridade
                if (priority && taskPriority !== priority) show = false;

                // Filtro de categoria
                if (category && taskCategory !== category) show = false;

                // Filtro de busca
                if (searchTerm && !title.includes(searchTerm) && !description.includes(searchTerm)) {
                    show = false;
                }

                task.style.display = show ? 'block' : 'none';
            });

            checkEmptyState();
        }

        function searchTasks() {
            applyFilters();
        }

        function checkEmptyState() {
            const visibleTasks = document.querySelectorAll('.task-card[style="display: block;"], .task-card:not([style*="display: none"])');
            const container = document.getElementById('tasksContainer');

            if (visibleTasks.length === 0) {
                if (!document.querySelector('.empty-state')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <div class="empty-state-title">Nenhuma tarefa encontrada</div>
                            <div class="empty-state-text">Tente ajustar os filtros ou criar uma nova tarefa</div>
                        </div>
                    `;
                }
            }
        }

        async function completeTask(button) {
            const taskCard = button.closest('.task-card');
            const taskId = taskCard.dataset.taskId;

            if (taskCard.classList.contains('completed')) {
                taskCard.classList.remove('completed');
                taskCard.dataset.status = 'pending';
                button.style.display = 'flex';
            } else {
                if (confirm('Marcar esta tarefa como concluída?')) {
                    taskCard.classList.add('completed');
                    taskCard.dataset.status = 'completed';
                    button.style.display = 'none';
                    try {
                        const response = await fetch(`/home/tarefa/finish/${taskId}`, {
                            method: 'PATCH'
                        });

                        if (response.ok) {
                            console.log('Tarefa Concluida com sucesso!');
                            taskCard.style.transform = 'scale(0.98)';
                            setTimeout(() => {
                                taskCard.style.transform = 'scale(1)';
                            }, 200);
                        } else {
                            console.error('Erro ao excluir tarefa:', response.status);
                            alert('Erro ao concluir tarefa. Tente novamente.');
                        }
                    } catch (error) {
                        console.error('Erro na requisição:', error);
                        alert('Erro de conexão. Verifique sua internet.');
                    }
                }
            }
        }

        function editTask(button) {
            alert('Abrindo formulário para editar tarefa...');
        }

        async function deleteTask(button) {
            if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                const taskCard = button.closest('.task-card');
                const taskId = taskCard.dataset.taskId;

                if (!taskId) {
                    alert('ID da tarefa não encontrado!');
                    return;
                }

                try {
                    const response = await fetch(`/home/tarefa/del/${taskId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        console.log('Tarefa excluída com sucesso!');
                        taskCard.style.opacity = '0';
                        taskCard.style.transform = 'translateX(-20px)';
                        setTimeout(() => {
                            taskCard.remove();
                            checkEmptyState();
                        }, 300);
                    } else {
                        console.error('Erro ao excluir tarefa:', response.status);
                        alert('Erro ao excluir tarefa. Tente novamente.');
                    }
                } catch (error) {
                    console.error('Erro na requisição:', error);
                    alert('Erro de conexão. Verifique sua internet.');
                }
            }
        }

        // Atalhos de teclado
        document.addEventListener('keydown', function (e) {
            // Ctrl/Cmd + K para focar na busca
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }

            // Ctrl/Cmd + N para nova tarefa
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                createTask();
            }
        });
    </script>
</body>

</html>